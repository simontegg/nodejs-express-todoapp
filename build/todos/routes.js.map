{"version":3,"sources":["../../src/todos/routes.js"],"names":["router","Router","route","get","getAllTodos","returnResponse","post","body","createTodo","delete","clearTodos","all","getOneTodo","patch","patchTodo","deleteTodo","req","res","next","locals","todos","todoTable","catch","err","rows","clear","status","order","position","todo","create","getById","params","id","NotFound","Object","assign","updatedTodo","update","deleteById","baseUrl","protocol","json"],"mappings":"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","file":"routes.js","sourcesContent":["import express from 'express';\nimport { validate } from 'isvalid';\nimport { errors } from 'express-simple-errors';\nimport transformResponse, { schema } from './model'; // eslint-disable-line no-unused-variables\nimport db from '../db';\nconst todoTable = 'todos';\n\nexport default function ()  {\n  const router = express.Router();\n\n  router.route('/')\n    .get(getAllTodos, returnResponse)\n    .post(validate.body(schema), createTodo, returnResponse)\n    .delete(clearTodos, returnResponse);\n\n  router.route('/:id')\n    .all(getOneTodo)\n    .get(returnResponse)\n    .patch(patchTodo, returnResponse)\n    .delete(deleteTodo, returnResponse);\n\n  async function getAllTodos(req, res, next) {\n    res.locals.todos = await db.all(todoTable)\n    .catch((err) => next(err));\n    next();\n  }\n\n  async function clearTodos(req, res, next) {\n    const rows = await db.clear(todoTable)\n    .catch((err) => next(err));\n    res.locals.todos = rows;\n    res.status(204);\n    next();\n  }\n\n  async function createTodo(req, res, next) {\n    if (req.body.order) {\n      req.body.position = req.body.order;\n      delete req.body.order;\n    }\n    const todo = await db.create(todoTable, req.body)\n    .catch((err) => next(err));\n    res.locals.todo = todo[0];\n    res.status(201);\n    next();\n  }\n\n  async function getOneTodo(req, res, next) {\n    const todo = await db.getById('todos', req.params.id)\n    .catch((err) => next(err));\n    res.locals.todo = todo && todo[0];\n    if (!res.locals.todo) {\n      return next(new errors.NotFound('This todo does not exist'));\n    }\n    next();\n  }\n\n  async function patchTodo(req, res, next) {\n    const todo = Object.assign({}, res.locals.todo[0], req.body);\n    if (todo.order) {\n      todo.position = todo.order;\n      delete todo.order;\n    }\n\n    const updatedTodo = await db.update(todoTable, req.params.id, todo)\n    .catch((err) => next(err));\n    res.locals.todo = updatedTodo[0];\n    next();\n  }\n\n  async function deleteTodo(req, res, next) {\n    res.locals.todo = await db.deleteById(todoTable, req.params.id)\n    .catch((err) => next(err));\n    res.status(204);\n    next();\n  }\n\n  function returnResponse(req, res) {\n    // handle no responses here\n    res.locals.baseUrl = `${req.protocol}://${req.get('host')}`;\n    res.json(transformResponse(res.locals));\n  }\n\n  return router;\n}\n"]}